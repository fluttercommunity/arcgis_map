"use strict";(self.webpackChunkarcgis_webpack01=self.webpackChunkarcgis_webpack01||[]).push([[8015],{8015:(e,a,t)=>{t.r(a),t.d(a,{save:()=>D,saveAll:()=>P,saveAs:()=>$});var r=t(7753),n=t(70375),s=t(13802),o=t(61681),l=t(78668),i=t(50516),u=t(12926),c=t(20692),y=t(8308),d=t(54957),p=t(26869),f=t(53110),m=t(84513),w=t(31370);const v=s.Z.getLogger("esri.layers.FeatureLayer"),b="Feature Service";function h(e,a){return`Layer (title: ${e.title}, id: ${e.id}) of type '${e.declaredClass}' ${a}`}function S(e,a){if(a.type!==b)throw new n.Z("feature-layer:portal-item-wrong-type",h(e,`should have portal item of type "${b}"`))}async function I(e){if(await e.load(),(0,d.rQ)(e))throw new n.Z("feature-layer:save",h(e,"using an in-memory source cannot be saved to a portal item"))}async function g(e,a,t){"beforeSave"in e&&"function"==typeof e.beforeSave&&await e.beforeSave();const r=e.write({},a);return function(e,a){let t=(e.messages??[]).filter((({type:e})=>"error"===e)).map((({name:e,message:a,details:t})=>new n.Z(e,a,t)));if(a?.ignoreUnsupported&&(t=t.filter((({name:e})=>"layer:unsupported"!==e&&"symbol:unsupported"!==e&&"symbol-layer:unsupported"!==e&&"property:unsupported"!==e&&"url:unsupported"!==e))),t.length>0)throw new n.Z("feature-layer:save","Failed to save feature layer due to unsupported or invalid content. See 'details.errors' for more detailed information",{errors:t})}(a,t),r}function K(e){const{layer:a,layerJSON:t}=e;return a.isTable?{layers:[],tables:[t]}:{layers:[t],tables:[]}}function T(e){(0,w.qj)(e,w.Kz.JSAPI),e.typeKeywords&&(e.typeKeywords=e.typeKeywords.filter(((e,a,t)=>t.indexOf(e)===a)))}async function J(e,a){return/\/\d+\/?$/.test(e.url??"")?K(a[0]):async function(e,a){const{layer:{url:t,customParameters:r,apiKey:n}}=a[0];let s=await e.fetchData("json");s&&null!=s.layers&&null!=s.tables||(s=await async function(e,a,t){var r,n;e||(e={}),(r=e).layers||(r.layers=[]),(n=e).tables||(n.tables=[]);const{url:s,customParameters:i,apiKey:c}=a,{serviceJSON:d,layersJSON:p}=await(0,y.V)(s,{customParameters:i,apiKey:c}),f=N(e.layers,d.layers,t),m=N(e.tables,d.tables,t);e.layers=f.itemResources,e.tables=m.itemResources;const w=[...f.added,...m.added],v=p?[...p.layers,...p.tables]:[];return await async function(e,a,t,r){const n=a.map((({id:e})=>new u.default({url:t,layerId:e,sourceJSON:r.find((({id:a})=>a===e))})));await(0,l.as)(n.map((e=>e.load()))),n.forEach((a=>{const{layerId:t,loaded:r,defaultPopupTemplate:n}=a;r&&!(0,o.Wi)(n)&&O(a,{id:t,popupInfo:n.toJSON()},e)}))}(e,w,s,v),e}(s,{url:t??"",customParameters:r,apiKey:n},a.map((e=>e.layer.layerId))));for(const e of a)O(e.layer,e.layerJSON,s);return s}(e,a)}function N(e,a,t){const n=(0,r.e5)(e,a,((e,a)=>e.id===a.id));e=e.filter((e=>!n.removed.some((a=>a.id===e.id))));const s=n.added.map((({id:e})=>({id:e})));return s.forEach((({id:a})=>{e.push({id:a})})),{itemResources:e,added:s.filter((({id:e})=>!t.includes(e)))}}function O(e,a,t){e.isTable?Z(t.tables,a):Z(t.layers,a)}function Z(e,a){if(!e)return;const t=e.findIndex((({id:e})=>e===a.id));-1===t?e.push(a):e[t]=a}function A(e){const{portalItem:a}=e;return(0,d.y2)(e)&&!e.dynamicDataSource&&!!a?.loaded&&a.type===b}const D=(0,l.Ds)((async function(e,a){await I(e),function(e){const a=e.portalItem;if(!a)throw v.error("save: requires the portalItem property to be set"),new n.Z("feature-layer:portal-item-not-set",h(e,"requires the portalItem property to be set"));if(!a.loaded)throw new n.Z("feature-layer:portal-item-not-loaded",h(e,"cannot be saved to a portal item that does not exist or is inaccessible"));S(e,a)}(e);const t=e.portalItem,r=(0,m.Y)(t),s=await g(e,r,a),o=await J(t,[{layer:e,layerJSON:s}]);return T(t),await t.update({data:o}),(0,i.D)(r),t}));const P=(0,l.Ds)((async(e,a)=>{await async function(e){if(!e?.length)throw new n.Z("feature-layer-utils-saveall:missing-parameters","'layers' array should contain at least one feature layer");await Promise.all(e.map((e=>e.load())));for(const a of e)if(!A(a))throw new n.Z("feature-layer-utils-saveall:invalid-parameters",`'layers' array should only contain layers or tables in a feature service loaded from 'Feature Service' item. ${h(a,"does not conform")}`,{layer:a});const a=e.map((e=>e.portalItem.id));if(new Set(a).size>1)throw new n.Z("feature-layer-utils-saveall:invalid-parameters","All layers in the 'layers' array should be loaded from the same portal item");const t=e.map((e=>e.layerId));if(new Set(t).size!==t.length)throw new n.Z("feature-layer-utils-saveall:invalid-parameters","'layers' array should contain only one instance each of layer or table in a feature service")}(e);const t=e[0].portalItem,r=(0,m.Y)(t),s=await Promise.all(e.map((e=>g(e,r,a)))),o=await J(t,e.map(((e,a)=>({layer:e,layerJSON:s[a]}))));return T(t),await t.update({data:o}),await Promise.all(e.slice(1).map((e=>e.portalItem.reload()))),(0,i.D)(r),t.clone()})),$=(0,l.Ds)((async function(e,a,t){await I(e);const r=function(e,a){var t,r;let n=f.default.from(a);return n.id&&(n=n.clone(),n.id=null),(t=n).type??(t.type=b),(r=n).portal??(r.portal=p.Z.getDefault()),S(e,n),n}(e,a),n=(0,m.Y)(r),s=K({layer:e,layerJSON:await g(e,n,t)});return await async function(e,a){const{url:t,layerId:r,title:n,fullExtent:s,isTable:l}=e,i=(0,c.Qc)(t),u=(0,o.pC)(i)&&"FeatureServer"===i.serverType;a.url=u?t:`${t}/${r}`,a.title||(a.title=n),a.extent=null,!l&&(0,o.pC)(s)&&(a.extent=await(0,w.$o)(s)),(0,w.ck)(a,w.Kz.METADATA),(0,w.ck)(a,w.Kz.MULTI_LAYER),(0,w.qj)(a,w.Kz.SINGLE_LAYER),l&&(0,w.qj)(a,w.Kz.TABLE),T(a)}(e,r),await async function(e,a,t){const r=e.portal;await(r?.signIn()),await(r?.user?.addItem({item:e,data:a,folder:t?.folder}))}(r,s,t),e.portalItem=r,(0,i.D)(n),r}))},8308:(e,a,t)=>{t.d(a,{V:()=>n});var r=t(40371);async function n(e,a){const t=await(0,r.T)(e,a);t.layers=t.layers.filter(s);const n={serviceJSON:t};if((t.currentVersion??0)<10.5)return n;const o=await(0,r.T)(e+"/layers",a);return n.layersJSON={layers:o.layers.filter(s),tables:o.tables},n}function s(e){return!e.type||"Feature Layer"===e.type}},40371:(e,a,t)=>{t.d(a,{T:()=>n});var r=t(66341);async function n(e,a){const{data:t}=await(0,r.default)(e,{responseType:"json",query:{f:"json",...a?.customParameters,token:a?.apiKey}});return t}}}]);