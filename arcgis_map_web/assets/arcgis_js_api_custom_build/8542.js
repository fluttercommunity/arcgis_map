"use strict";(self.webpackChunkarcgis_webpack01=self.webpackChunkarcgis_webpack01||[]).push([[8542],{63886:(e,t,i)=>{i.d(t,{Z:()=>g});var n=i(36663),o=i(15065),r=i(53443),s=i(41151),a=i(82064),l=i(61681),u=i(81977),d=(i(7753),i(7283),i(40266)),c=i(42557),p=i(67666),h=i(74710);let v=class extends((0,a.eC)((0,s.J)(r.Z))){constructor(e){super(e),this.position=null,this.elevationInfo=null,this.feature=null}equals(e){return(0,l._W)(this.position,e.position)&&(0,l._W)(this.elevationInfo,e.elevationInfo)&&(0,o.kk)(this.feature,e.feature)}};(0,n._)([(0,u.Cb)({type:p.Z}),(0,c.B)()],v.prototype,"position",void 0),(0,n._)([(0,u.Cb)({type:h.Z}),(0,c.B)()],v.prototype,"elevationInfo",void 0),(0,n._)([(0,u.Cb)(o.rX)],v.prototype,"feature",void 0),v=(0,n._)([(0,d.j)("esri.analysis.LineOfSightAnalysisObserver")],v);const g=v},31200:(e,t,i)=>{i.d(t,{Z:()=>v});var n=i(36663),o=i(15065),r=i(41151),s=i(82064),a=i(61681),l=i(81977),u=(i(7753),i(7283),i(40266)),d=i(42557),c=i(67666),p=i(74710);let h=class extends((0,s.eC)(r.j)){constructor(e){super(e),this.position=null,this.elevationInfo=null,this.feature=null}equals(e){return(0,a._W)(this.position,e.position)&&(0,a._W)(this.elevationInfo,e.elevationInfo)&&(0,o.kk)(this.feature,e.feature)}};(0,n._)([(0,l.Cb)({type:c.Z}),(0,d.B)()],h.prototype,"position",void 0),(0,n._)([(0,l.Cb)({type:p.Z}),(0,d.B)()],h.prototype,"elevationInfo",void 0),(0,n._)([(0,l.Cb)(o.rX)],h.prototype,"feature",void 0),h=(0,n._)([(0,u.j)("esri.analysis.LineOfSightAnalysisTarget")],h);const v=h},15065:(e,t,i)=>{i.d(t,{kk:()=>o,pD:()=>r,rX:()=>s});var n=i(61681);function o(e,t){return r(e)===r(t)}function r(e){if((0,n.Wi)(e))return null;const t=null!=e.layer?e.layer.id:"";let i=null;return i=null!=e.objectId?e.objectId:null!=e.layer&&"objectIdField"in e.layer&&null!=e.layer.objectIdField&&null!=e.attributes?e.attributes[e.layer.objectIdField]:e.uid,null==i?null:`o-${t}-${i}`}const s={json:{write:{writer:function(e,t){(0,n.Wi)(e)||null==e.layer?.objectIdField||null==e.attributes||(t.feature={layerId:e.layer.id,objectId:e.attributes[e.layer.objectIdField]})},target:{"feature.layerId":{type:[Number,String]},"feature.objectId":{type:[Number,String]}}},origins:{"web-scene":{read:function(e){if(null!=e.layerId&&null!=e.objectId)return{uid:null,layer:{id:e.layerId,objectIdField:"ObjectId"},attributes:{ObjectId:e.objectId}}}}}}}},60573:(e,t,i)=>{i.d(t,{p:()=>u});var n=i(36663),o=i(23148),r=i(61681),s=i(64189),a=i(81977),l=(i(7753),i(7283),i(40266));const u=e=>{let t=class extends((0,s.v)(e)){constructor(){super(...arguments),this.parent=null,this._userInteractive=!1,this._interactiveViewModelCount=0}get interactive(){return this._interactiveViewModelCount>0||this._userInteractive}set interactive(e){this._userInteractive=e}get updating(){return!1}get visible(){return!(0,r.pC)(this.parent)||this.parent.visible&&!this.parent.suspended}set visible(e){this._overrideIfSome("visible",e)}forceInteractiveForViewModel(){return this._interactiveViewModelCount++,(0,o.kB)((()=>this._interactiveViewModelCount--))}};return(0,n._)([(0,a.Cb)({readOnly:!0})],t.prototype,"type",void 0),(0,n._)([(0,a.Cb)({constructOnly:!0})],t.prototype,"analysis",void 0),(0,n._)([(0,a.Cb)({constructOnly:!0})],t.prototype,"parent",void 0),(0,n._)([(0,a.Cb)({constructOnly:!0})],t.prototype,"view",void 0),(0,n._)([(0,a.Cb)({type:Boolean})],t.prototype,"interactive",null),(0,n._)([(0,a.Cb)()],t.prototype,"_userInteractive",void 0),(0,n._)([(0,a.Cb)({readOnly:!0})],t.prototype,"updating",null),(0,n._)([(0,a.Cb)()],t.prototype,"visible",null),(0,n._)([(0,a.Cb)()],t.prototype,"_interactiveViewModelCount",void 0),t=(0,n._)([(0,l.j)("esri.views.3d.analysis.AnalysisView3D")],t),t}},78542:(e,t,i)=>{i.r(t),i.d(t,{default:()=>je});var n=i(36663),o=i(53443),r=i(41831),s=i(31355),a=i(61681),l=i(81977),u=i(7753),d=(i(7283),i(40266)),c=i(8909),p=i(60573),h=i(30936);let v=class extends o.Z{constructor(e){super(e),this.innerWidth=2,this.outerWidth=8,this.visibleInnerColor=new h.Z([3,252,111,1]),this.visibleOuterColor=new h.Z([3,252,111,.15]),this.occludedInnerColor=new h.Z([252,3,69,1]),this.occludedOuterColor=new h.Z([252,3,69,.1]),this.undefinedInnerColor=new h.Z([255,255,255,1]),this.undefinedOuterColor=new h.Z([127,127,127,.2])}};(0,n._)([(0,l.Cb)({type:Number})],v.prototype,"innerWidth",void 0),(0,n._)([(0,l.Cb)({type:Number})],v.prototype,"outerWidth",void 0),(0,n._)([(0,l.Cb)({type:h.Z})],v.prototype,"visibleInnerColor",void 0),(0,n._)([(0,l.Cb)({type:h.Z})],v.prototype,"visibleOuterColor",void 0),(0,n._)([(0,l.Cb)({type:h.Z})],v.prototype,"occludedInnerColor",void 0),(0,n._)([(0,l.Cb)({type:h.Z})],v.prototype,"occludedOuterColor",void 0),(0,n._)([(0,l.Cb)({type:h.Z})],v.prototype,"undefinedInnerColor",void 0),(0,n._)([(0,l.Cb)({type:h.Z})],v.prototype,"undefinedOuterColor",void 0),v=(0,n._)([(0,d.j)("esri.views.3d.analysis.LineOfSight.LineOfSightConfiguration")],v);i(91957);var g=i(15065),_=i(67979),y=i(44584),b=i(23148),C=i(13802),m=i(78668),f=i(76868),w=i(6766),I=i(81589),O=i(90472),T=i(24568),S=i(97537),P=i(83772);let V=class extends o.Z{constructor(e){super(e),this.target=null,this.intersectedGraphic=null,this.intersectedLocation=null,this.elevationAlignedTargetLocation=null,this.visible=void 0}};(0,n._)([(0,l.Cb)()],V.prototype,"target",void 0),(0,n._)([(0,l.Cb)()],V.prototype,"intersectedGraphic",void 0),(0,n._)([(0,l.Cb)()],V.prototype,"intersectedLocation",void 0),(0,n._)([(0,l.Cb)()],V.prototype,"elevationAlignedTargetLocation",void 0),(0,n._)([(0,l.Cb)({type:Boolean})],V.prototype,"visible",void 0),V=(0,n._)([(0,d.j)("esri.views.3d.analysis.LineOfSightAnalysisResult")],V);let L=class extends o.Z{constructor(e){super(e),this.elevationAlignedTargetLocation=null,this.inputPoints={isValid:!1,observer:(0,c.c)(),observerSurfaceNormal:null,observerFeatureId:null,target:(0,c.c)(),targetSurfaceNormal:null,targetFeatureId:null,observerAdjusted:(0,c.c)(),targetAdjusted:(0,c.c)()},this.computationResult={start:(0,c.c)(),end:(0,c.c)(),intersection:(0,c.c)(),isValid:!1,isTargetVisible:!1},this.result=null}notifyResultChanged(){this.notifyChange("computationResult")}notifyInputPointsChanged(){this.notifyChange("inputPoints")}};(0,n._)([(0,l.Cb)()],L.prototype,"target",void 0),(0,n._)([(0,l.Cb)()],L.prototype,"elevationAlignedTargetLocation",void 0),(0,n._)([(0,l.Cb)()],L.prototype,"inputPoints",void 0),(0,n._)([(0,l.Cb)()],L.prototype,"computationResult",void 0),(0,n._)([(0,l.Cb)()],L.prototype,"result",void 0),L=(0,n._)([(0,d.j)("esri.views.3d.analysis.LineOfSight.LineOfSightComputation")],L);var R,E=i(95550),A=i(68817),Z=i(48358),z=i(67134);let M=R=class extends o.Z{constructor(e){super(e)}clone(){return new R({type:this.type,id:(0,z.d9)(this.id),mapPoint:(0,z.d9)(this.mapPoint),renderPoint:(0,c.a)(this.renderPoint),normal:(0,z.d9)(this.normal),ray:(0,z.d9)(this.ray),graphic:this.graphic})}equals(e){return this.type===e.type&&this.id===e.id&&(0,a._W)(this.mapPoint,e.mapPoint)&&(0,w.F)(this.renderPoint,e.renderPoint)&&(0,u.fS)(this.normal,e.normal)&&(0,S.fS)(this.ray,e.ray)&&this.graphic===e.graphic}};(0,n._)([(0,l.Cb)()],M.prototype,"type",void 0),(0,n._)([(0,l.Cb)({constructOnly:!0})],M.prototype,"id",void 0),(0,n._)([(0,l.Cb)({constructOnly:!0})],M.prototype,"mapPoint",void 0),(0,n._)([(0,l.Cb)({constructOnly:!0})],M.prototype,"renderPoint",void 0),(0,n._)([(0,l.Cb)({constructOnly:!0})],M.prototype,"normal",void 0),(0,n._)([(0,l.Cb)({constructOnly:!0})],M.prototype,"graphic",void 0),(0,n._)([(0,l.Cb)({constructOnly:!0})],M.prototype,"ray",void 0),M=R=(0,n._)([(0,d.j)("esri.views.3d.analysis.LineOfSight.LineOfSightIntersectionResult")],M);var H=i(94576),W=i(40460),k=i(87564),D=i(8927),x=i(20757),j=i(5865);let F=class extends o.Z{constructor(e){super(e),this._terrainIntersectionOptionsLayerUids=new Set(["terrain"])}initialize(){this.intersector=(0,D.Z8)(this.view.state.viewingMode),this.intersector.options.hud=!1,this.intersector.options.store=x.eC.MIN}getScreenPointIntersection(e){const t=(0,E.md)(e,A.qW.get()),i=(0,W.u4)(this.view.state.camera,t,q);return this._getRayIntersection(i)}_getRayIntersection(e,t){if((0,a.Wi)(e)||(0,a.Wi)(this.view.sceneIntersectionHelper))return null;this.intersector.options.store=x.eC.MIN,this.view.sceneIntersectionHelper.intersectToolIntersectorRay(e,this.intersector,t);const i=this.intersector.results.min,n=(0,c.c)();if(!i.getIntersectionPoint(n))return null;const o=this.view.renderCoordsHelper.fromRenderCoords(n,this.view.spatialReference),r=(0,c.a)(i.normal);if((0,H.G)(i))return new M({type:x.q7.OBJECT,id:`${i.target.layerUid}/${i.target.nodeIndex}/${i.target.componentIndex}`,mapPoint:o,renderPoint:n,normal:r,ray:(0,S.JG)(e),graphic:null});if((0,k.T)(i))return new M({type:x.q7.TERRAIN,id:i.target.lij.slice(),mapPoint:o,renderPoint:n,normal:r,ray:(0,S.JG)(e),graphic:null});const s=(0,j.tB)(i,this.view);if((0,a.pC)(s)){const t=s.layer,i=s.sourceLayer;let a;return a=i&&"scene"===i.type?(0,Z.MS)(s,i.objectIdField):s.uid,new M({type:x.q7.OBJECT,id:`${t.uid}/${a}`,mapPoint:o,renderPoint:n,normal:r,ray:(0,S.JG)(e),graphic:s})}return null}updateFromGroundIntersection(e,t,i){const n=G,o=N,r=B,s=U;(0,w.c)(o,e),this.view.renderCoordsHelper.worldUpAtPosition(o,r),(0,w.n)(r,r);const l=this.view.basemapTerrain.visibleElevationBounds,u=l?Math.abs(l.max-l.min):100,d=t>=0?1:-1;(0,w.g)(s,r,d*(u+Math.abs(t))),(0,w.a)(n,o,s),(0,S.zk)(n,o,q);const p=this._getRayIntersection(q,{include:this._terrainIntersectionOptionsLayerUids});return(0,a.pC)(p)?((0,w.g)(s,r,d*t),(0,w.a)(i,p.renderPoint,s),(0,c.a)(p.normal)):((0,w.c)(i,e),null)}};(0,n._)([(0,l.Cb)()],F.prototype,"view",void 0),(0,n._)([(0,l.Cb)()],F.prototype,"intersector",void 0),F=(0,n._)([(0,d.j)("esri.views.3d.analysis.LineOfSight.LineOfSightRayIntersector")],F);const G=(0,c.c)(),N=(0,c.c)(),B=(0,c.c)(),U=(0,c.c)(),q=(0,S.Ue)();var X=i(28376),J=i(22167),$=i(67666);const Y="esri.views.3d.analysis.LineOfSight.LineOfSightController",Q=C.Z.getLogger(Y);let K=class extends(s.Z.EventedMixin(o.Z)){constructor(e){super(e),this.updateOnCameraChange=!0,this._effectiveObserverElevationMode="absolute-height",this._observerFeatureId=null,this._updatingHandles=new I.t,this._frameTask=J.sq,this._handles=new y.Z,this._computationHandles=new y.Z,this._externalObserverUpdate=!0}initialize(){const e=this.view.resourceController?.scheduler;this._frameTask=e?e.registerTask(J.T8.LINE_OF_SIGHT_TOOL):J.sq,this._intersector=new F({view:this.view}),this._handles.add([this._connectObserver(),this._connectComputations(),this._connectTargets()])}destroy(){this._handles.destroy(),this._computationHandles.destroy(),this._computations.removeAll(),this._updatingHandles.destroy()}get updating(){return this._frameTask.updating||this._updatingHandles.updating}get priority(){return this._frameTask.priority}set priority(e){this._frameTask.priority=e}get _computations(){return this.analysisViewData.computations}get _elevationAlignedObserverPositionRenderSpace(){return this.analysisViewData.observerEngineLocation}set _elevationAlignedObserverPositionRenderSpace(e){this.analysisViewData.observerEngineLocation=e}get _screenPixelSize(){return this.view.state.camera.computeScreenPixelSizeAt(this._elevationAlignedObserverPositionRenderSpace)}_computeResult(e){const t=e.computation,{inputPoints:i,computationResult:n}=t,{observerAdjusted:o,targetAdjusted:r}=i,{start:s,end:a}=n;(0,w.c)(s,o),(0,w.c)(a,r),this._canCompute(t)?this._computeIntersection(e):this._interpolateIntersection(e),t.notifyResultChanged(),this.emit("result-changed",{target:e.computation.target,result:t.result})}_updateAdjustedPointsFromFeatures(e){const t=this.view,{sceneIntersectionHelper:i}=t,{inputPoints:n}=e,{observerAdjusted:o,observerFeatureId:r,targetFeatureId:s,targetAdjusted:l}=n;if((0,a.Wi)(r)&&(0,a.Wi)(s))return;const u=(0,w.i)(o,l),d=this._intersector.intersector,p=(0,S.zk)(n.observer,n.target,ie);d.options.store=x.eC.ALL,i.intersectToolIntersectorRay(p,d);let h=null,v=null,_=null,y=null;for(const e of d.results.all){const i=(0,j.tB)(e,this.view);if((0,a.Wi)(i)||(0,a.Wi)(e.distanceInRenderSpace))continue;const n=(0,g.pD)(i);(0,a.Wi)(n)||((0,a.pC)(r)&&n===r&&((0,a.Wi)(h)&&(h=this._getFeatureDistanceThreshold(e,t,u)),e.distanceInRenderSpace<h&&(_=e)),(0,a.pC)(s)&&n===s&&((0,a.Wi)(v)&&(v=this._getFeatureDistanceThreshold(e,t,u)),(0,a.Wi)(y)&&e.distanceInRenderSpace<u&&u-e.distanceInRenderSpace<v&&(y=e)))}(0,a.pC)(_)&&_.getIntersectionPoint(o)&&(n.observerSurfaceNormal=_.getTransformedNormal((0,c.c)())),(0,a.pC)(y)&&y.getIntersectionPoint(l)&&(n.targetSurfaceNormal=y.getTransformedNormal((0,c.c)()))}_getFeatureDistanceThreshold(e,t,i){if((0,j._s)(e)){const n=(0,j.VB)(e,t);if((0,a.pC)(n))return Math.min(n*oe,i)}return 1e-5*i}_adjustStartEndPositions(e){const t=this._screenPixelSize,i=this.view,{inputPoints:n}=e,{observer:o,observerSurfaceNormal:r,target:s,targetSurfaceNormal:l,observerAdjusted:u,targetAdjusted:d}=n,c=te;(0,w.c)(u,o),(0,w.c)(d,s),this._updateAdjustedPointsFromFeatures(e),(0,a.pC)(r)?(0,w.c)(c,r):(0,w.b)(c,d,u);const p=t;(0,w.n)(c,c),(0,w.g)(c,c,Math.min(p,1)),(0,w.a)(u,u,c),(0,a.pC)(l)?(0,w.c)(c,l):(0,w.b)(c,u,d);const h=i.state.camera.computeScreenPixelSizeAt(d);(0,w.n)(c,c),(0,w.g)(c,c,Math.min(h,1)),(0,w.a)(d,d,c)}_computeIntersection({computation:e,interpolationInfo:t}){const{view:i}=this,{sceneIntersectionHelper:n,renderCoordsHelper:o}=i;if((0,a.Wi)(n))return;const r=this._intersector.intersector,{computationResult:s,inputPoints:l}=e,{observer:u,target:d}=l,{start:c,end:p}=s,h=(0,S.zk)(c,p,ie);r.options.store=x.eC.MIN,n.intersectToolIntersectorRay(h,r);const v=r.results.min,g=s.intersection,_=te;let y=!0;if((0,a.pC)(v)&&v.getIntersectionPoint(g)){(0,w.c)(t.originalIntersection,g),(0,w.c)(t.originalObserver,c),(0,w.c)(t.originalTarget,p),o.fromRenderCoords(g,_,i.spatialReference);const e=1-(0,w.j)(p,d)/(0,w.j)(c,d);y=(0,w.j)(u,g)>=e*(0,w.j)(u,d)}const b=new $.Z(_,i.spatialReference);{const{result:t,target:n}=e;(0,a.pC)(t)?(t.target=n,t.intersectedGraphic=y?null:(0,j.tB)(v,i),t.intersectedLocation=y?null:b,t.visible=y):e.result=new V({target:n,elevationAlignedTargetLocation:e.elevationAlignedTargetLocation,intersectedGraphic:y?null:(0,j.tB)(v,i),intersectedLocation:y?null:b,visible:y})}s.isValid=l.isValid=!0,s.isTargetVisible=y}_interpolateIntersection({computation:e,interpolationInfo:t}){const{computationResult:i,inputPoints:n}=e,{start:o,end:r,intersection:s}=i,{originalIntersection:a,originalObserver:l,originalTarget:u}=t;if((0,w.c)(s,a),n.isValid){const e=te,t=(0,w.j)(l,a)/(0,w.j)(l,u);(0,w.y)(e,o,l),(0,w.g)(e,e,1-t),(0,w.a)(s,s,e),(0,w.y)(e,r,u),(0,w.g)(e,e,t),(0,w.a)(s,s,e),i.isValid=!0}else e.result=null,i.isValid=!1,i.isTargetVisible=!1}_canCompute(e){const t=this.analysisViewData.elevationAlignedObserver,i=this.view.frustum;if((0,a.Wi)(t)||(0,a.Wi)(e.elevationAlignedTargetLocation)||(0,a.Wi)(i))return!1;const{observerAdjusted:n,targetAdjusted:o}=e.inputPoints,r=i.intersectsPoint(n),s=i.intersectsPoint(o);return r&&s}_onObserverPositionChange(e,t,i,n,o){if(this._externalObserverUpdate=o,(0,a.Wi)(e))return this.analysisViewData.elevationAlignedObserver=null,void(this._observerFeatureId=null);if((0,a.Wi)(t))return(0,X.e)(this.analysis,e.spatialReference,Q),void(this.analysisViewData.elevationAlignedObserver=null);const r=this._getEffectiveElevationInfo(t,i),{absoluteZ:s,elevation:l}=(0,P.tq)(t.x,t.y,t.z,this.view.spatialReference,this.view,r),u=t.clone();u.z=s,this._effectiveObserverElevationMode=r.mode,this.analysisViewData.elevationAlignedObserver=u;const d=(0,c.c)();this.view.renderCoordsHelper.toRenderCoords(u,d),this._elevationAlignedObserverPositionRenderSpace=d,this._observerGroundOffsetRenderSpace=s-l,this._observerFeatureId=(0,g.pD)(n),this.priority=J.T8.LINE_OF_SIGHT_TOOL_INTERACTIVE}_onObserverRenderSpacePositionChangeForComputation(e,t,i,n,o){const{inputPoints:r}=e;switch((0,w.c)(r.observer,t),r.observerFeatureId=o,r.observerSurfaceNormal=null,n){case"on-the-ground":case"relative-to-ground":{const e=this._intersector.updateFromGroundIntersection(r.observer,i,r.observer);(0,a.Wi)(r.observerFeatureId)&&(r.observerSurfaceNormal=e)}}this._adjustStartEndPositions(e),e.notifyInputPointsChanged(),this.priority=J.T8.LINE_OF_SIGHT_TOOL_INTERACTIVE}_onTargetPositionChange(e,t,i,n,o,r=!0){const s=e.inputPoints;if(r&&(s.isValid=!1),(0,a.Wi)(i))return(0,a.pC)(t)&&(0,X.e)(this.analysis,t.spatialReference,Q),e.elevationAlignedTargetLocation=null,void e.notifyInputPointsChanged();const l=this._getEffectiveElevationInfo(i,n),{absoluteZ:u,elevation:d}=(0,P.tq)(i.x,i.y,i.z,this.view.spatialReference,this.view,l),c=i.clone();switch(c.z=u,e.elevationAlignedTargetLocation=c,this.view.renderCoordsHelper.toRenderCoords(e.elevationAlignedTargetLocation,s.target),s.targetFeatureId=(0,g.pD)(o),s.targetSurfaceNormal=null,l.mode){case"on-the-ground":case"relative-to-ground":{const e=this._intersector.updateFromGroundIntersection(s.target,u-d,s.target);(0,a.Wi)(s.targetFeatureId)&&(s.targetSurfaceNormal=e)}}this._adjustStartEndPositions(e),e.notifyInputPointsChanged(),this.priority=J.T8.LINE_OF_SIGHT_TOOL_INTERACTIVE}_connectComputationToTarget(e){return(0,b.AL)([this._updatingHandles.add((()=>({computation:e,targetPosition:e.target.position,targetElevationInfo:e.target.elevationInfo,targetFeatureInfo:e.target.feature,projectedTargetPosition:(0,O.dz)(e.target.position,this.view.spatialReference)})),(({computation:e,targetPosition:t,targetElevationInfo:i,targetFeatureInfo:n,projectedTargetPosition:o})=>{(0,a.pC)(o.pending)?this._updatingHandles.addPromise(o.pending):this._onTargetPositionChange(e,t,o.geometry,i,n)}),f.nn)])}_connectComputationToObserver(e){return this._updatingHandles.add((()=>({computation:e,observer:this.analysisViewData.elevationAlignedObserver})),(({computation:e})=>{this._externalObserverUpdate&&(e.inputPoints.isValid=!1,e.notifyInputPointsChanged())}),f.nn)}_connectComputationToRenderSpaceObserver(e){return this._updatingHandles.add((()=>({computation:e,observer:this._elevationAlignedObserverPositionRenderSpace,observerGroundOffset:this._observerGroundOffsetRenderSpace,observerElevationMode:this._effectiveObserverElevationMode,observerFeatureId:this._observerFeatureId})),(({computation:e,observer:t,observerGroundOffset:i,observerElevationMode:n,observerFeatureId:o})=>{this._onObserverRenderSpacePositionChangeForComputation(e,t,i,n,o)}),f.nn)}_connectComputationToCamera(e){return this._updatingHandles.add((()=>({camera:this.view.state.camera,isDirty:this._isCameraDirty})),(({isDirty:t})=>{!this.updateOnCameraChange||e.inputPoints.isValid&&!t||e.notifyInputPointsChanged()}))}_connectComputationToSlicePlane(e){return this._updatingHandles.add((()=>this.view.slicePlane),(()=>{e.inputPoints.isValid=!1,e.notifyInputPointsChanged()}))}_connectComputationToElevation(e){const t=(i,n)=>{const o=this.analysis.observer,r=e.target;let s=null,l=null,u=null,d=null,c=null,p=null;if((0,a.pC)(o)&&(0,a.pC)(o.position)){const e=(0,O.dz)(o.position,this.view.spatialReference);if((0,a.pC)(e.pending))return this._updatingHandles.addPromise(e.pending),void e.pending.finally((()=>t(i,n)));s=e.geometry,l=o.elevationInfo,u=o.feature}if((0,a.pC)(r.position)){const e=(0,O.dz)(r.position,this.view.spatialReference);if((0,a.pC)(e.pending))return this._updatingHandles.addPromise(e.pending),void e.pending.finally((()=>t(i,n)));d=e.geometry,c=r.elevationInfo,p=r.feature}(0,a.Wi)(s)&&(0,a.Wi)(d)||((0,O.dH)(i,n,ne,this.view.spatialReference),(0,a.pC)(s)&&(0,T.Qn)(ne,s)&&this._onObserverPositionChange((0,a.pC)(o)?o.position:null,s,l,u,!1),(0,a.pC)(d)&&(0,T.Qn)(ne,d)&&this._onTargetPositionChange(e,r.position,d,c,p,!1),(0,a.pC)(s)&&(0,a.pC)(d)&&(0,T.I7)(ne,s,d)&&e.notifyInputPointsChanged())};return this.view.elevationProvider.on("elevation-change",(e=>t(e.extent,e.spatialReference)))}_connectComputationToTask(e){let t=a.YP;const i={computation:e,interpolationInfo:{originalIntersection:(0,c.c)(),originalObserver:(0,c.c)(),originalTarget:(0,c.c)()}};return(0,b.AL)([this._updatingHandles.add((()=>e.inputPoints),(()=>{t=(0,a.IM)(t),t=(0,_.vr)((async e=>{await(0,m.R8)(this._frameTask.schedule((()=>this._computeResult(i)),e))}))}),{initial:!0,equals:()=>!1}),(0,b.kB)((()=>t=(0,a.IM)(t)))])}_connectComputation(e){const t=this._computationHandles;t.has(e)||t.add([this._connectComputationToTarget(e),this._connectComputationToObserver(e),this._connectComputationToRenderSpaceObserver(e),this._connectComputationToCamera(e),this._connectComputationToSlicePlane(e),this._connectComputationToElevation(e),this._connectComputationToTask(e)],e)}_disconnectComputation(e){this._computationHandles.remove(e)}_onComputationCollectionChange({added:e,removed:t}){for(const e of t)this._disconnectComputation(e);for(const t of e)this._connectComputation(t)}_onTargetCollectionChange({added:e,removed:t}){for(const e of t)this._removeTarget(e);for(const t of e)this._addTarget(t)}_onCursorTargetChange(e,t){(0,a.pC)(t)&&this._removeTarget(t),(0,a.pC)(e)&&this._addTarget(e)}_addTarget(e){this._computations.some((t=>t.target===e))||this._computations.add(new L({target:e}))}_removeTarget(e){const t=this._computations.findIndex((t=>t.target===e));this._computations.removeAt(t)}_connectObserver(){return(0,b.AL)([this._updatingHandles.add((()=>({observerPosition:(0,a.pC)(this.analysis.observer)?this.analysis.observer.position:null,projectedObserverPosition:(0,O.dz)((0,a.pC)(this.analysis.observer)?this.analysis.observer.position:null,this.view.spatialReference),observerElevationInfo:(0,a.pC)(this.analysis.observer)?this.analysis.observer.elevationInfo:null,observerFeatureInfo:(0,a.pC)(this.analysis.observer)?this.analysis.observer.feature:null})),(({observerPosition:e,projectedObserverPosition:t,observerElevationInfo:i,observerFeatureInfo:n})=>{(0,a.pC)(t.pending)?this._updatingHandles.addPromise(t.pending):this._onObserverPositionChange(e,t.geometry,i,n,!0)}),f.nn)])}_connectComputations(){return this._updatingHandles.addOnCollectionChange((()=>this._computations),(e=>this._onComputationCollectionChange(e)),{initial:!0,final:!0})}_connectTargets(){return(0,b.AL)([this._updatingHandles.addOnCollectionChange((()=>this.analysis.targets),(e=>this._onTargetCollectionChange(e)),{initial:!0,final:!0}),this._updatingHandles.add((()=>this.analysisViewData.cursorTarget),((e,t)=>{this._onCursorTargetChange(e,t)}))])}get _isCameraDirty(){const e=this.analysisViewData.elevationAlignedObserver,{view:t}=this,{renderCoordsHelper:i}=t;if((0,a.Wi)(e)||(0,a.Wi)(i))return!1;const n=te;i.toRenderCoords(e,n);const o=t.state.camera.computeScreenPixelSizeAt(n);return Math.abs((o-this._screenPixelSize)/this._screenPixelSize)>ee}_getEffectiveElevationInfo(e,t){return e.hasZ?(0,a.Pt)(t,{mode:"absolute-height",offset:0}):{mode:"on-the-ground",offset:0}}};(0,n._)([(0,l.Cb)({constructOnly:!0})],K.prototype,"analysis",void 0),(0,n._)([(0,l.Cb)({constructOnly:!0})],K.prototype,"analysisViewData",void 0),(0,n._)([(0,l.Cb)({constructOnly:!0})],K.prototype,"view",void 0),(0,n._)([(0,l.Cb)()],K.prototype,"updating",null),(0,n._)([(0,l.Cb)()],K.prototype,"priority",null),(0,n._)([(0,l.Cb)()],K.prototype,"updateOnCameraChange",void 0),(0,n._)([(0,l.Cb)()],K.prototype,"_computations",null),(0,n._)([(0,l.Cb)()],K.prototype,"_elevationAlignedObserverPositionRenderSpace",null),(0,n._)([(0,l.Cb)()],K.prototype,"_observerGroundOffsetRenderSpace",void 0),(0,n._)([(0,l.Cb)()],K.prototype,"_effectiveObserverElevationMode",void 0),(0,n._)([(0,l.Cb)()],K.prototype,"_observerFeatureId",void 0),(0,n._)([(0,l.Cb)()],K.prototype,"_screenPixelSize",null),(0,n._)([(0,l.Cb)({readOnly:!0})],K.prototype,"_updatingHandles",void 0),(0,n._)([(0,l.Cb)()],K.prototype,"_frameTask",void 0),(0,n._)([(0,l.Cb)()],K.prototype,"_isCameraDirty",null),K=(0,n._)([(0,d.j)(Y)],K);const ee=.1,te=(0,c.c)(),ie=(0,S.Ue)(),ne=(0,T.cS)(),oe=.05;var re=i(63886),se=i(31200),ae=i(56215),le=i(74710);let ue=class extends o.Z{constructor(e){super(e),this.enabled=!0,this.glowColor=new h.Z([255,127,0]),this.glowWidth=8,this.innerColor=new h.Z([255,255,255]),this.innerWidth=.75,this.globalAlpha=.75}};(0,n._)([(0,l.Cb)({type:Boolean})],ue.prototype,"enabled",void 0),(0,n._)([(0,l.Cb)({type:h.Z})],ue.prototype,"glowColor",void 0),(0,n._)([(0,l.Cb)({type:Number})],ue.prototype,"glowWidth",void 0),(0,n._)([(0,l.Cb)({type:h.Z})],ue.prototype,"innerColor",void 0),(0,n._)([(0,l.Cb)({type:Number})],ue.prototype,"innerWidth",void 0),(0,n._)([(0,l.Cb)({type:Number})],ue.prototype,"globalAlpha",void 0),ue=(0,n._)([(0,d.j)("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightLaserLineConfiguration")],ue);let de=class extends o.Z{constructor(e){super(e),this.size=.5,this.color=new h.Z([255,127,0,.75])}};(0,n._)([(0,l.Cb)({type:Number})],de.prototype,"size",void 0),(0,n._)([(0,l.Cb)({type:h.Z})],de.prototype,"color",void 0),de=(0,n._)([(0,d.j)("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightObserverConfiguration")],de);let ce=class extends o.Z{constructor(e){super(e),this.size=.5,this.visibleColor=new h.Z([3,252,111,.75]),this.occludedColor=new h.Z([252,3,69,.75]),this.undefinedColor=new h.Z([127,127,127,.75])}};(0,n._)([(0,l.Cb)({type:Number})],ce.prototype,"size",void 0),(0,n._)([(0,l.Cb)({type:h.Z})],ce.prototype,"visibleColor",void 0),(0,n._)([(0,l.Cb)({type:h.Z})],ce.prototype,"occludedColor",void 0),(0,n._)([(0,l.Cb)({type:h.Z})],ce.prototype,"undefinedColor",void 0),ce=(0,n._)([(0,d.j)("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightTargetConfiguration")],ce);class pe extends o.Z{constructor(e){super(e),this.innerWidth=2,this.outerWidth=8,this.visibleInnerColor=new h.Z([3,252,111,1]),this.visibleOuterColor=new h.Z([3,252,111,.15]),this.occludedInnerColor=new h.Z([252,3,69,1]),this.occludedOuterColor=new h.Z([252,3,69,.1]),this.undefinedInnerColor=new h.Z([255,255,255,1]),this.undefinedOuterColor=new h.Z([127,127,127,.2])}}(0,n._)([(0,l.Cb)({type:Number})],pe.prototype,"innerWidth",void 0),(0,n._)([(0,l.Cb)({type:Number})],pe.prototype,"outerWidth",void 0),(0,n._)([(0,l.Cb)({type:h.Z})],pe.prototype,"visibleInnerColor",void 0),(0,n._)([(0,l.Cb)({type:h.Z})],pe.prototype,"visibleOuterColor",void 0),(0,n._)([(0,l.Cb)({type:h.Z})],pe.prototype,"occludedInnerColor",void 0),(0,n._)([(0,l.Cb)({type:h.Z})],pe.prototype,"occludedOuterColor",void 0),(0,n._)([(0,l.Cb)({type:h.Z})],pe.prototype,"undefinedInnerColor",void 0),(0,n._)([(0,l.Cb)({type:h.Z})],pe.prototype,"undefinedOuterColor",void 0);let he=class extends o.Z{constructor(e){super(e),this.laserLine=new ue,this.observer=new de,this.target=new ce,this.lineOfSight=new pe}};(0,n._)([(0,l.Cb)({type:ue})],he.prototype,"laserLine",void 0),(0,n._)([(0,l.Cb)({type:de})],he.prototype,"observer",void 0),(0,n._)([(0,l.Cb)({type:ce})],he.prototype,"target",void 0),(0,n._)([(0,l.Cb)({type:pe})],he.prototype,"lineOfSight",void 0),he=(0,n._)([(0,d.j)("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightToolConfiguration")],he);var ve=i(46707),ge=i(74390),_e=i(41652),ye=i(6087),be=i(91258);function Ce(e,t,i){return{geometry:(0,ye.PI)(e,32,32),material:(0,ge.EA)(h.Z.toUnitRGBA(t)),stateMask:i}}function me(e){const t=[];return e.customColor1&&t.push(Ce(e.size,e.customColor1,be.jg.Custom1)),e.customColor2&&t.push(Ce(e.size,e.customColor2,be.jg.Custom2)),e.customColor3&&t.push(Ce(e.size,e.customColor3,be.jg.Custom3)),e.color&&t.push(Ce(e.size,e.color)),t}var fe,we,Ie=i(40199),Oe=(i(3846),i(2523)),Te=i(76478),Se=i(38114),Pe=i(51986);(we=fe||(fe={})).Ready="ready",we.Creating="creating",we.Created="created";let Ve=class extends Oe.f{constructor(e){super(e),this.removeIncompleteOnCancel=!1,this.configuration=new he,this.analysisViewData=null,this._laserlineVisualElement=null,this._grabbedManipulator=null,this._analysisHandles=new y.Z,this._handles=new y.Z,this._updatingHandles=new I.t,this._manipulatorHandles=new y.Z,this._targetTrackerManipulator=null}initialize(){this._intersector=new F({view:this.view}),this._handles.add((0,f.YP)((()=>this.state),(e=>{e===fe.Created&&this.finishToolCreation()}),f.tX)),this._observerManipulator=this._createObserverManipulator(),this._handles.add([this._updatingHandles.add((()=>({...this.configuration.observer})),(()=>this._updateObserverManipulatorStyle())),this._updatingHandles.add((()=>this.analysisViewData.elevationAlignedObserver),(e=>this._onObserverLocationChange(e)),f.nn),this._updatingHandles.add((()=>({...this.configuration.laserLine})),(()=>this._createVisualElements()),f.nn),this._updatingHandles.add((()=>this._laserLineRendererDependencies()),(e=>this._updateLaserLineRenderer(e))),this._connectComputations(),this._updatingHandles.addWhen((()=>!this._shouldRenderTracker),(()=>this._clearCursorTracker()),f.nn)])}destroy(){this._updatingHandles=(0,a.SC)(this._updatingHandles),this._handles=(0,a.SC)(this._handles),this._manipulatorHandles=(0,a.SC)(this._manipulatorHandles),this._analysisHandles=(0,a.SC)(this._analysisHandles),this._observerManipulator=null,this._clearCursorTracker(),this._removeVisualElements(),this._intersector=null,this._set("analysis",null)}get state(){return this.active?this.hasGrabbedManipulators?fe.Created:fe.Creating:(0,a.pC)(this.analysis.observer)&&(0,a.pC)(this.analysis.observer.position)?fe.Created:fe.Ready}get cursor(){return this.active&&this._showTracker?"crosshair":null}get updating(){return(0,a.pC)(this.analysisViewData)&&this.analysisViewData.updating||this._updatingHandles.updating}get _showTracker(){return this.active&&"mouse"===this._latestPointerMovePointerType}get _shouldRenderTracker(){return this._showTracker&&(0,a.pC)(this.analysis.observer)&&(0,a.pC)(this.analysis.observer.position)&&!this.hasGrabbedManipulators}continue(){this.view.activeTool=this}stop(){this.view.activeTool=null}onEditableChange(){this.analysisViewData.editable=this.internallyEditable}onInputEvent(e){switch(e.type){case"immediate-double-click":this._doubleClickHandler(e);break;case"key-down":this._keyDownHandler(e);break;case"pointer-move":this._pointerMoveHandler(e)}}onInputEventAfter(e){"immediate-click"===e.type&&this._clickHandler(e)}onShow(){}onHide(){}onDeactivate(){this._clearCursorTracker()}_connectComputations(){return this._updatingHandles.addOnCollectionChange((()=>this.analysisViewData.computations),(e=>this._onComputationsCollectionChange(e)),{initial:!0,final:!0})}_onComputationsCollectionChange({added:e,removed:t}){for(const e of t)this._disconnectComputation(e);for(const t of e)this._connectComputation(t)}_connectComputation(e){if(this.destroyed)return void C.Z.getLogger(this.declaredClass).warn("Attempting to connect an analysis to a destroyed LineOfSight tool. Ignoring.");const t=this._analysisHandles;if(t.has(e))return;const i=this._createTargetManipulator(e.target);(0,a.Wi)(this._targetTrackerManipulator)&&i.metadata.target===this.analysisViewData.cursorTarget&&(this._targetTrackerManipulator=i,this._targetTrackerManipulator.available=!1,this._targetTrackerManipulator.interactive=!1,this._updateLaserLineRenderer()),t.add([this._updatingHandles.add((()=>this._getLineOfSightManipulatorStateDependencies(e)),(()=>this._updateManipulatorState(i,e)),f.nn),this._updatingHandles.add((()=>e.elevationAlignedTargetLocation),(e=>this._onTargetLocationChange(e,i)),f.nn)],e)}_disconnectComputation(e){if(this.destroyed)return void C.Z.getLogger(this.declaredClass).warn("Attempting to disconnect an analysis from a destroyed LineOfSight tool. Ignoring.");this._analysisHandles.remove(e);const t=this._getTargetManipulator(e.target);(0,a.pC)(t)&&(this.manipulators.remove(t),this._manipulatorHandles.remove(t),(0,a.pC)(this._targetTrackerManipulator)&&this._targetTrackerManipulator===t&&(this._targetTrackerManipulator=null))}_clearCursorTracker(){this.analysisViewData.cursorTarget=(0,a.SC)(this.analysisViewData.cursorTarget)}_createManipulator(e,t,i){const n=function(e,t){const i=me(t),n=new ve.Z({view:e,renderObjects:i,elevationInfo:{mode:"absolute-height",offset:0}});return(0,_e.t)(n),n}(this.view,e);return n.metadata=i,this._manipulatorHandles.add([t(n),n.events.on("grab-changed",(e=>this._manipulatorGrabChanged(n,e))),n.events.on("immediate-click",(e=>this._manipulatorClick(n,e)))],n),this.manipulators.add(n),n}_createTargetManipulator(e){const t=this.configuration,i={size:t.target.size,customColor1:t.target.visibleColor,customColor2:t.target.occludedColor,customColor3:t.target.undefinedColor,visible:!0},n={target:e,type:"target"},o=this._createManipulator(i,(e=>this._createTargetManipulatorDragPipeline(e)),n);return(0,a.pC)(e.position)?o.elevationAlignedLocation=e.position:o.available=!1,o}_getTargetManipulator(e){let t=null;return this.manipulators.forEach((i=>{const n=i.manipulator;(0,a.Wi)(t)&&"target"===n.metadata.type&&n.metadata.target===e&&(t=n)})),t}_createObserverManipulator(){const e=this.configuration,t={size:e.observer.size,color:e.observer.color,visible:!0};return this._createManipulator(t,(e=>this._createObserverManipulatorDragPipeline(e)),{type:"observer",intersection:null})}_updateObserverManipulatorStyle(){const e=this._observerManipulator,t=this.configuration.observer,i={size:t.size,color:t.color,visible:e.available};e.renderObjects=me(i)}_screenToIntersection(){return e=>{const t=this._intersector.getScreenPointIntersection(e.screenEnd);return(0,a.Wi)(t)?null:{...e,intersection:t}}}_createTargetManipulatorDragPipeline(e){return(0,Te.Xd)(e,((t,i,n)=>{i.next(this._screenToIntersection()).next(this._updateTargetDragStep(e)).next((()=>this._updateLaserLineRenderer())),n.next(this._cancelTargetDragStep(e.metadata.target)).next((()=>this._updateLaserLineRenderer()))}))}_createObserverManipulatorDragPipeline(e){return(0,Te.Xd)(e,((e,t,i)=>{t.next(this._screenToIntersection()).next(this._updateObserverDragStep()).next((()=>this._updateLaserLineRenderer())),i.next(this._cancelObserverDragStep()).next((()=>this._updateLaserLineRenderer()))}))}_updateObserverDragStep(){return e=>((0,a.pC)(e.intersection.mapPoint)?((0,a.Wi)(this.analysis.observer)&&(this.analysis.observer=new re.Z),this._updateFromIntersection(this.analysis.observer,e.intersection)):this.analysis.observer=null,e)}_cancelObserverDragStep(){const e=(0,a.pC)(this.analysis.observer)&&(0,a.pC)(this.analysis.observer.position)?this.analysis.observer.clone():null;return t=>(this.analysis.observer=e,t)}_updateTargetDragStep(e){return t=>{this._updateFromIntersection(e.metadata.target,t.intersection);const i=t.intersection.mapPoint;return(0,a.pC)(i)&&(e.elevationAlignedLocation=i),t}}_cancelTargetDragStep(e){const t=(0,a.yw)(e.position,(e=>e.clone()));return i=>(e.position=t,i)}_manipulatorGrabChanged(e,t){switch(t.action){case"start":this._grabbedManipulator=e;break;case"end":this._grabbedManipulator===e&&(this._grabbedManipulator=null)}}_updateManipulatorState(e,t){const{isValid:i,isTargetVisible:n}=t.computationResult;e.state=i?n?be.jg.Custom1:be.jg.Custom2:be.jg.Custom3}_getLineOfSightManipulatorStateDependencies(e){const{isValid:t,isTargetVisible:i}=e.computationResult;return{isValid:t,isTargetVisible:i}}_laserLineRendererDependencies(){return{laserlineVisualElement:this._laserlineVisualElement,grabbedManipulator:this._grabbedManipulator,shouldRenderTracker:this._shouldRenderTracker,observerPosition:(0,a.pC)(this.analysis.observer)?this.analysis.observer.position:null,visible:this.visible}}_updateLaserLineRenderer(e=this._laserLineRendererDependencies()){const{laserlineVisualElement:t,grabbedManipulator:i,shouldRenderTracker:n,observerPosition:o,visible:r}=e;if((0,a.Wi)(t))return;const s=(0,a.pC)(i)?i:n&&(0,a.pC)(o)?this._targetTrackerManipulator:null;this.configuration.laserLine.enabled&&(0,a.pC)(s)&&r?(t.visible=!0,t.heightManifoldTarget=s.renderLocation,s!==this._observerManipulator?t.lineVerticalPlaneSegment=(0,ae.zk)(this._observerManipulator.renderLocation,s.renderLocation,Le):t.lineVerticalPlaneSegment=null):(t.visible=!1,t.heightManifoldTarget=null,t.lineVerticalPlaneSegment=null)}_createVisualElements(){const e=this.configuration.laserLine;this._removeVisualElements(),this._laserlineVisualElement=new Ie.W({view:this.view,attached:!0,visible:this.visible,style:{glowColor:h.Z.toUnitRGB(e.glowColor),glowWidth:e.glowWidth,innerColor:h.Z.toUnitRGB(e.innerColor),innerWidth:e.innerWidth,globalAlpha:e.globalAlpha}})}_removeVisualElements(){(0,a.pC)(this._laserlineVisualElement)&&(this._laserlineVisualElement.destroy(),this._laserlineVisualElement=null)}_onObserverLocationChange(e){(0,a.Wi)(e)?this._observerManipulator.available=!1:(this._observerManipulator.metadata.intersection=null,this._observerManipulator.available=!0,this._observerManipulator.elevationAlignedLocation=e)}_onTargetLocationChange(e,t){(0,a.pC)(e)?(t.elevationAlignedLocation=e,t!==this._targetTrackerManipulator&&(t.available=!0)):t.available=!1}_addPointFromClickEvent(e){const t=this._intersector.getScreenPointIntersection(e);if(!(0,a.Wi)(t)&&!(0,a.Wi)(t.mapPoint))if((0,a.pC)(this.analysis.observer)&&(0,a.pC)(this.analysis.observer.position)){this._clearCursorTracker();const e=new se.Z;this._updateFromIntersection(e,t),this.analysis.targets.add(e)}else{const e=new re.Z;this._updateFromIntersection(e,t),this.analysis.observer=e}}_clickHandler(e){this.active&&e.button!==Pe.t.Right&&(this._addPointFromClickEvent((0,Se.vT)(e)),e.stopPropagation())}_doubleClickHandler(e){this.active&&e.button!==Pe.t.Right&&(this.stop(),e.stopPropagation())}_keyDownHandler(e){this.active&&"Escape"===e.key&&(this.stop(),e.stopPropagation())}_pointerMoveHandler(e){if(this.hasGrabbedManipulators)return;if(this._latestPointerMovePointerType=e.pointerType,this._updateLaserLineRenderer(),!this._showTracker||(0,a.Wi)(this.analysis.observer)||(0,a.Wi)(this.analysis.observer.position))return;const t=(0,Se.vT)(e),i=this._intersector.getScreenPointIntersection(t);(0,a.pC)(i)&&(0,a.pC)(i.mapPoint)&&((0,a.Wi)(this.analysisViewData.cursorTarget)&&(this.analysisViewData.cursorTarget=new se.Z),this._updateFromIntersection(this.analysisViewData.cursorTarget,i),this._updateLaserLineRenderer())}_updateFromIntersection(e,t){if((0,a.Wi)(t.mapPoint))return e.position=null,e.elevationInfo=null,void(e.feature=null);switch(t.type){case x.q7.OBJECT:if((0,a.pC)(t.graphic)){const i=t.graphic,n=(0,P.RL)(i);"on-the-ground"===n.mode&&(n.mode="relative-to-ground",n.offset=0),e.elevationInfo=new le.Z(n),e.feature=i}else e.elevationInfo=null,e.feature=null;break;case x.q7.TERRAIN:case x.q7.I3S:e.elevationInfo=new le.Z({mode:"on-the-ground"}),e.feature=null;break;default:e.elevationInfo=null,e.feature=null}const i=t.mapPoint.clone();i.z=(0,P.vQ)(this.view,i,{mode:"absolute-height",offset:0},e.elevationInfo),e.position=i}_manipulatorClick(e,t){if("observer"===e.metadata.type||e.grabbing||e.dragging||t.button!==Pe.t.Right||this.analysis.targets.length<=1)return;const{target:i}=e.metadata;this.analysis.targets.remove(i),t.stopPropagation()}get testInfo(){return{laserLineVisualElement:this._laserlineVisualElement}}};(0,n._)([(0,l.Cb)({constructOnly:!0})],Ve.prototype,"view",void 0),(0,n._)([(0,l.Cb)({constructOnly:!0})],Ve.prototype,"analysis",void 0),(0,n._)([(0,l.Cb)({readOnly:!0})],Ve.prototype,"state",null),(0,n._)([(0,l.Cb)({readOnly:!0})],Ve.prototype,"cursor",null),(0,n._)([(0,l.Cb)()],Ve.prototype,"removeIncompleteOnCancel",void 0),(0,n._)([(0,l.Cb)({readOnly:!0})],Ve.prototype,"updating",null),(0,n._)([(0,l.Cb)({type:he})],Ve.prototype,"configuration",void 0),(0,n._)([(0,l.Cb)({constructOnly:!0})],Ve.prototype,"analysisViewData",void 0),(0,n._)([(0,l.Cb)({readOnly:!0})],Ve.prototype,"_showTracker",null),(0,n._)([(0,l.Cb)()],Ve.prototype,"_latestPointerMovePointerType",void 0),(0,n._)([(0,l.Cb)()],Ve.prototype,"_shouldRenderTracker",null),(0,n._)([(0,l.Cb)()],Ve.prototype,"_laserlineVisualElement",void 0),(0,n._)([(0,l.Cb)()],Ve.prototype,"_grabbedManipulator",void 0),Ve=(0,n._)([(0,d.j)("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightTool")],Ve);const Le=(0,ae.Ue)();var Re=i(39100),Ee=i(37926),Ae=i(26653);let Ze=class extends o.Z{constructor(e){super(e),this._lineOfSightVisualizations=[],this._computationHandles=new y.Z,this._updatingHandles=new I.t}initialize(){this.addHandles(this._connectComputations()),this._createObserverVisualization()}destroy(){this._updatingHandles=(0,a.SC)(this._updatingHandles),this._computationHandles=(0,a.SC)(this._computationHandles),this._observerVisualElement=(0,a.SC)(this._observerVisualElement)}get visible(){return this.analysisViewData.visible}get updating(){return this._updatingHandles.updating}get interactiveAndEditable(){return this.analysisViewData.interactive&&this.analysisViewData.editable}get testInfo(){return{visualizations:this._lineOfSightVisualizations}}get _configuration(){return this.analysisViewData.configuration}_createLineOfSightVisualization(){const e=this._configuration,t=this.view,i={view:t,attached:!0,width:e.outerWidth,innerWidth:e.innerWidth},n=h.Z.toUnitRGBA(e.visibleOuterColor),o=h.Z.toUnitRGBA(e.visibleInnerColor),r=h.Z.toUnitRGBA(e.occludedOuterColor),s=h.Z.toUnitRGBA(e.occludedInnerColor),a=h.Z.toUnitRGBA(e.undefinedOuterColor),l=h.Z.toUnitRGBA(e.undefinedInnerColor),u={visibleLineVisualElement:new Ee.r({...i,color:n,innerColor:o}),occludedLineVisualElement:new Ee.r({...i,color:r,innerColor:s}),undefinedLineVisualElement:new Ee.r({...i,color:a,innerColor:l}),targetVisualElement:new Ae.L({view:t,attached:!0,...ze,size:8})};return this._lineOfSightVisualizations.push(u),u}_destroyLineOfSightVisualization(e){e.visibleLineVisualElement=(0,a.SC)(e.visibleLineVisualElement),e.occludedLineVisualElement=(0,a.SC)(e.occludedLineVisualElement),e.undefinedLineVisualElement=(0,a.SC)(e.undefinedLineVisualElement),e.targetVisualElement=(0,a.SC)(e.targetVisualElement),this._lineOfSightVisualizations.splice(this._lineOfSightVisualizations.indexOf(e),1)}_updateLineOfSightVisualization(e,t,i){const n=this._configuration,{computationResult:o,inputPoints:r}=e,{start:s,end:l,intersection:u,isValid:d,isTargetVisible:p}=o,{observer:v}=r,g=ke;g[12]=v[0],g[13]=v[1],g[14]=v[2];const _=(0,w.b)(Me,s,v),y=(0,w.b)(He,l,v),b=(0,w.b)(We,u,v),{visibleLineVisualElement:C,occludedLineVisualElement:m,undefinedLineVisualElement:f,targetVisualElement:I}=t,O=(0,a.Wi)(this.analysisViewData.elevationAlignedObserver)||(0,a.Wi)(e.elevationAlignedTargetLocation),T=this.visible&&!O;C.visible=T,m.visible=T,f.visible=T,I.visible=T,I.attached=!i.interactiveAndEditable,T&&(C.geometry=null,m.geometry=null,f.geometry=null,I.geometry=e.elevationAlignedTargetLocation,d?p?(C.geometry=[[(0,c.d)(_),(0,c.d)(y)]],C.transform=g,C.color=h.Z.toUnitRGBA(n.visibleOuterColor),I.color=h.Z.toUnitRGBA(n.visibleInnerColor)):(C.geometry=[[(0,c.d)(_),(0,c.d)(b)]],C.transform=g,C.color=h.Z.toUnitRGBA(n.occludedOuterColor),m.geometry=[[(0,c.d)(b),(0,c.d)(y)]],m.transform=g,I.color=h.Z.toUnitRGBA(n.occludedInnerColor)):(f.geometry=[[(0,c.d)(_),(0,c.d)(y)]],f.transform=g,I.color=h.Z.toUnitRGBA(n.undefinedInnerColor)))}_getLineOfSightVisualizationDependencies(e){const{computationResult:t}=e,{occludedOuterColor:i,visibleOuterColor:n}=this._configuration;return{computationResult:t,occludedOuterColor:i,visibleOuterColor:n,visible:this.visible,interactiveAndEditable:this.interactiveAndEditable}}_connectComputation(e){const t=this._computationHandles;if(t.has(e))return;const i=this._createLineOfSightVisualization();t.add([this._updatingHandles.add((()=>this._getLineOfSightVisualizationDependencies(e)),(t=>this._updateLineOfSightVisualization(e,i,t)),{initial:!0,equals:()=>!1}),(0,b.kB)((()=>this._destroyLineOfSightVisualization(i)))],e)}_disconnectComputation(e){this._computationHandles.remove(e)}_connectComputations(){return this._updatingHandles.addOnCollectionChange((()=>this.analysisViewData.computations),(e=>this._onComputationsCollectionChange(e)),{initial:!0,final:!0})}_onComputationsCollectionChange({added:e,removed:t}){for(const e of t)this._disconnectComputation(e);for(const t of e)this._connectComputation(t)}_createObserverVisualization(){const e=h.Z.toUnitRGBA(this._configuration.visibleInnerColor),t=new Ae.L({view:this.view,attached:!1,color:e,...ze});this._observerVisualElement=t,this.addHandles(this._updatingHandles.add((()=>({observer:this.analysisViewData.elevationAlignedObserver,interactiveAndEditable:this.interactiveAndEditable,visible:this.visible})),(({observer:e,interactiveAndEditable:i,visible:n})=>{(0,a.Wi)(e)||i||!n?t.attached=!1:(t.geometry=e,this._observerVisualElement.attached=!0)}),f.nn))}};(0,n._)([(0,l.Cb)({constructOnly:!0})],Ze.prototype,"analysis",void 0),(0,n._)([(0,l.Cb)({constructOnly:!0})],Ze.prototype,"analysisViewData",void 0),(0,n._)([(0,l.Cb)({constructOnly:!0})],Ze.prototype,"view",void 0),(0,n._)([(0,l.Cb)({readOnly:!0})],Ze.prototype,"visible",null),(0,n._)([(0,l.Cb)()],Ze.prototype,"updating",null),(0,n._)([(0,l.Cb)()],Ze.prototype,"interactiveAndEditable",null),(0,n._)([(0,l.Cb)()],Ze.prototype,"testInfo",null),(0,n._)([(0,l.Cb)()],Ze.prototype,"_configuration",null),Ze=(0,n._)([(0,d.j)("esri.views.3d.analysis.LineOfSight.LineOfSightVisualization")],Ze);const ze={size:6,pixelSnappingEnabled:!1,primitive:"circle",elevationInfo:{mode:"absolute-height",offset:0},outlineSize:0},Me=(0,c.c)(),He=(0,c.c)(),We=(0,c.c)(),ke=(0,Re.c)();var De=i(76497);let xe=class extends((0,p.p)(s.Z.EventedMixin(o.Z))){constructor(e){super(e),this.type="line-of-sight-view-3d",this.analysis=null,this.tool=null,this.computations=new r.Z,this.elevationAlignedObserver=null,this.configuration=new v,this.observerEngineLocation=(0,c.c)(),this.cursorTarget=null,this.editable=!0}initialize(){const e=this.view,t=this.analysis;this._analysisController=new K({analysis:t,analysisViewData:this,view:e}),this._analysisVisualization=new Ze({analysis:t,analysisViewData:this,view:e}),this.addHandles([this._analysisController.on("result-changed",(e=>{e.target!==this.cursorTarget&&this.emit("result-changed",e)})),(0,De.Lp)(this,Ve)])}destroy(){(0,De.Yq)(this),this._analysisController=(0,a.SC)(this._analysisController),this._analysisVisualization=(0,a.SC)(this._analysisVisualization)}get results(){return this.computations.map((e=>e.result))}get priority(){return this._analysisController.priority}set priority(e){this._analysisController.priority=e}get updating(){return(0,a.pC)(this._analysisController)&&this._analysisController.updating||(0,a.pC)(this._analysisVisualization)&&this._analysisVisualization.updating}getResultForTarget(e){const t=this.computations.find((t=>t.target===e));return(0,a.yw)(t,(e=>e.result))}get testInfo(){return{visualization:this._analysisVisualization,controller:this._analysisController}}};(0,n._)([(0,l.Cb)({readOnly:!0})],xe.prototype,"type",void 0),(0,n._)([(0,l.Cb)({constructOnly:!0,nonNullable:!0})],xe.prototype,"analysis",void 0),(0,n._)([(0,l.Cb)()],xe.prototype,"tool",void 0),(0,n._)([(0,l.Cb)({readOnly:!0})],xe.prototype,"results",null),(0,n._)([(0,l.Cb)()],xe.prototype,"priority",null),(0,n._)([(0,l.Cb)()],xe.prototype,"computations",void 0),(0,n._)([(0,l.Cb)()],xe.prototype,"elevationAlignedObserver",void 0),(0,n._)([(0,l.Cb)()],xe.prototype,"configuration",void 0),(0,n._)([(0,l.Cb)()],xe.prototype,"observerEngineLocation",void 0),(0,n._)([(0,l.Cb)()],xe.prototype,"cursorTarget",void 0),(0,n._)([(0,l.Cb)()],xe.prototype,"updating",null),(0,n._)([(0,l.Cb)()],xe.prototype,"editable",void 0),(0,n._)([(0,l.Cb)()],xe.prototype,"_analysisController",void 0),(0,n._)([(0,l.Cb)()],xe.prototype,"_analysisVisualization",void 0),xe=(0,n._)([(0,d.j)("esri.views.3d.analysis.LineOfSightAnalysisView3D")],xe);const je=xe},41652:(e,t,i)=>{i.d(t,{c:()=>r,t:()=>s});var n=i(61681),o=i(83772);function r(e,t=(0,o.RL)(e)){return"on-the-ground"!==t.mode&&!((0,n.Wi)(e.geometry)||!e.geometry.hasZ)}function s(e,t){let i=null;const o=e.events.on("grab-changed",(o=>{(0,n.pC)(i)&&(i.remove(),i=null),"start"===o.action?(i=e.disableDisplay(),t&&t(o)):t&&t(o)}));return{remove(){(0,n.pC)(i)&&i.remove(),o.remove()}}}},26653:(e,t,i)=>{i.d(t,{L:()=>C});var n=i(19431),o=i(61681),r=i(6766),s=i(8909),a=i(88589),l=i(1983),u=i(90472),d=i(37116),c=i(68817),p=i(7426),h=i(63669),v=i(29642),g=i(48807),_=i(6087),y=i(21414),b=i(98166);class C{constructor(e){this.view=null,this._geometry=null,this._size=3,this._color=(0,l.f)(1,0,1,1),this._pixelSnappingEnabled=!0,this._primitive="square",this._outlineSize=1,this._outlineColor=(0,l.f)(1,1,1,1),this._elevationInfo=null,this._resources=new p.O({view:e.view,createResources:e=>this._createResources(e),recreateGeometry:(e,t)=>(e.geometry=this._recreateGeometry(t,e.material),(0,o.pC)(e.geometry)?[e.geometry]:[])});let t=!0;for(const i in e)i in this?"attached"===i?t=e[i]:this[i]=e[i]:console.error("Cannot set unknown property",i);this.attached=t}destroy(){this._resources.destroy()}get visible(){return this._resources.visible}set visible(e){this._resources.visible=e}get attached(){return this._resources.attached}set attached(e){this._resources.attached=e}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this._resources.recreateGeometry()}get size(){return this._size}set size(e){if(e!==this._size){const t=this._preferredTextureSize;this._size=e,t<this._preferredTextureSize?(0,o.pC)(this._resources)&&this._resources.recreate():this._updateSizeAttribute()}}get color(){return this._color}set color(e){(0,a.g)(e,this._color)||((0,a.c)(this._color,e),this._updateMaterial())}get pixelSnappingEnabled(){return this._pixelSnappingEnabled}set pixelSnappingEnabled(e){this._pixelSnappingEnabled!==e&&(this._pixelSnappingEnabled=e,this._updateMaterial())}get primitive(){return this._primitive}set primitive(e){this._primitive!==e&&(this._primitive=e,(0,o.pC)(this._resources)&&this._resources.recreate())}get outlineSize(){return this._outlineSize}set outlineSize(e){e!==this._outlineSize&&(this._outlineSize=e,this._updateMaterial())}get outlineColor(){return this._outlineColor}set outlineColor(e){(0,a.g)(e,this._outlineColor)||((0,a.c)(this._outlineColor,e),this._updateMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this._resources&&this._resources.recreateGeometry()}_updateMaterial(){const e=this._resources.resources;(0,o.Wi)(e)||e.material.setParameters(this._materialParameters(e.texture.id))}_updateSizeAttribute(){const e=this._resources.resources,t=this._resources.object;if((0,o.Wi)(e)||(0,o.Wi)(t))return;const i=e.geometry;if((0,o.Wi)(i))return;const n=i.getMutableAttribute(y.T.SIZE).data,r=this._geometrySize;n[0]=r,n[1]=r,t.geometryVertexAttrsUpdated(t.geometryRecords[0])}_materialParameters(e){return{color:this._color,textureIsSignedDistanceField:!0,distanceFieldBoundingBox:f,occlusionTest:!1,outlineColor:this._outlineColor,outlineSize:this._outlineSize,textureId:e,polygonOffset:!1,shaderPolygonOffset:0,drawInSecondSlot:!0,depthEnabled:!1,pixelSnappingEnabled:this.pixelSnappingEnabled}}get _geometrySize(){return this._size/m}_recreateGeometry(e,t){const i=this._createRenderGeometry();return(0,o.pC)(i)&&e.addGeometry(i,t),i}_createResources(e){const t=(0,g.cU)(this._primitive,this._preferredTextureSize),i=new b.A(this._materialParameters(t.id)),n=this._recreateGeometry(e,i);return{material:i,texture:t,geometry:n,forEach(e){e(t),e(i),(0,o.pC)(this.geometry)&&e(this.geometry)}}}get _preferredTextureSize(){return(0,n.uZ)((0,n.Sf)(2*this._geometrySize),16,128)}calculateMapBounds(e){if((0,o.Wi)(this._resources.resources)||(0,o.Wi)(this._resources.resources.geometry))return!1;const t=this._resources.resources.geometry.vertexAttributes.get(y.T.POSITION);return(0,u.SH)(t.data,this.view.renderCoordsHelper.spatialReference,w,this.view.spatialReference),(0,d.G1)(e,w),!0}_createRenderGeometry(){const e=this.geometry;if((0,o.Wi)(e))return null;const{renderCoordsHelper:t,elevationProvider:i}=this.view,n=(0,h.w7)(e,i,v.o.fromElevationInfo(this.elevationInfo),t),s=(0,r.s)(c.WM.get(),e.x,e.y,n),a=c.WM.get();(0,u.SH)(s,e.spatialReference,a,t.spatialReference);const l=this._geometrySize;return(0,_.dV)(null,a,null,[l,l],[0,0,0,1])}}const m=g.Ns,f=[m/2,m/2,1-m/2,1-m/2],w=(0,s.c)()},76497:(e,t,i)=>{i.d(t,{Er:()=>a,Lp:()=>l,Yq:()=>u});var n=i(67979),o=i(61681),r=i(78668),s=i(76868);function a(e,t){e.interactive=!0;const{tool:i,view:a}=e;a.activeTool=i;let l=(0,r.fu)(t,(()=>{a.activeTool===i&&(a.activeTool=null)}));return(0,n.vr)((async e=>{await(0,s.N1)((()=>(0,o.Wi)(i)||!i.active),e),l=(0,o.hw)(l)}),t)}function l(e,t){return(0,s.YP)((()=>e.interactive),(()=>function(e,t){e.interactive?function(e,t){u(e);const{view:i,analysis:n}=e,o=new t({view:i,analysis:n,analysisViewData:e});e.tool=o,i.tools.add(o)}(e,t):u(e)}(e,t)),s.tX)}function u(e){const{view:t,tool:i}=e;(0,o.Wi)(i)||(t.tools.remove(i),e.tool=null)}},2523:(e,t,i)=>{i.d(t,{f:()=>l});var n=i(36663),o=i(76868),r=i(81977),s=(i(7753),i(7283),i(40266)),a=i(68610);let l=class extends a.m{constructor(e){super(e)}initialize(){this.addHandles((0,o.YP)((()=>this.analysisViewData.visible),(e=>this.visible=e),o.tX))}deactivate(){this.onDeactivate(),this.created||this.analysis.clear()}resetCreated(){this._set("created",!1)}};(0,n._)([(0,r.Cb)({constructOnly:!0})],l.prototype,"analysis",void 0),(0,n._)([(0,r.Cb)()],l.prototype,"analysisViewData",void 0),l=(0,n._)([(0,s.j)("esri.views.interactive.AnalysisToolBase")],l)}}]);